(function(e){function M(a,b){return d3.max(a,function(a){return b||"9999"!=a.year?1==k?a.creator+a.recipient+a.mentioned:d3.max([a.creator,a.recipient,a.mentioned]):0})}function N(a,b){for(var n=[],m=a.length,d=0;d<m;d++){var c=a[d].year;if(b||"9999"!=c)"9999"==c?n.push("?"):n.push(c)}return n}function O(a,b){var c=[],m=b/a.length,d=10,e;40<m?d=1:20<m?d=3:10<m&&(d=5);for(e=0;e<a.length;e++)m=a[e],0!=e%d&&"?"!=m||c.push(m);return c}function P(a,b){var c=3;a<c?c=a:3!=b&&a>=3*c&&(c*=3);return c}function Q(a, b){return 3!=b&&a&&2<=a.length?d3.min([a[1]-a[0]-1,4]):0}function w(a){return a<c.length?c[a]:""}function J(a,U){function n(b,c){c?p.selectAll(b).transition().duration(a/2).delay(3*a/2).style("opacity","1"):p.selectAll(b).transition().duration(3*a/2).style("opacity","0")}e=q?y:D;A=e.length;E=M(e,q,h);var m=60;if(1==k||2==k)m=R-20-20;l.domain([0,E]).range([m,0]);var d=N(e,q);r.domain(d);var d=O(r.domain(),z),g=P(E,k);for(f=0;f<c.length;f++){var h=c[f],u=K[h].x,t=K[h].y;u.scale(r).tickValues(d);t.scale(l).ticks(g); t.tickSubdivide(Q(l.ticks(g),k));p.select(".xaxis."+h).transition().duration(a).call(u);p.select(".yaxis."+h).transition().duration(a).call(t)}d=l.ticks(g);d=p.select("g.guidelines").selectAll("line.guideline."+w(0)).data(d,function(a,b){return 0==a?0:b+"-"+w(0)});d.enter().append("line").classed("guideline",1).classed(w(0),1).attr("x1",35).attr("x2",35+z);d.exit().remove();d.transition().duration(a).attr("y1",function(a){return 20+l(a)}).attr("y2",function(a){return 20+l(a)});if(1==k||2==k){for(b= 0;b<c.length-1;b++)n(".xaxis."+c[b],!1);for(b=1;b<c.length;b++)n(".yaxis."+c[b],!1),n(".guideline."+c[b],!1),n(".chart-title."+c[b],!1);d=x[0];3==c.length?d+=", "+x[1]+" and "+x[2]:2==c.length&&(d+=" and "+x[1]);p.select(".chart-title."+w(0)).text(d)}if(3==k){for(b=0;b<c.length-1;b++)n(".xaxis."+c[b],!0);for(b=1;b<c.length;b++)n(".yaxis."+c[b],!0),n(".guideline."+c[b],!0),n(".chart-title."+c[b],!0);0<c.length&&p.select(".chart-title."+w(0)).text(x[0])}for(b=0;b<c.length;b++)if(h=c[b],B[h]){var v= 125*b+20;if(1==k||2==k)v=20;d=p.selectAll("rect."+h).data(e,function(a){return a.year+"-"+h});d.enter().append("rect").classed("bar",1).classed(h,1).attr("x",35+z+2).attr("y",v+m).attr("width",r.rangeBand()).attr("height",0).classed("unknown",function(a){return"9999"==a.year});d.exit().transition().duration(a).attr("x",35+z+2).remove();d.append("title").text(function(a){return("9999"!=a.year?a.year:"Years unknown")+": "+a[h]+" "+x[b]});S&&d.attr("x",function(a,b){return 35+r(b)});d.transition().duration(a).delay(U).attr("x", function(a,b){var d=0;2==k&&(h==w(1)?d=r.rangeBand()/c.length:h==w(2)&&(d=2*r.rangeBand()/c.length));return 35+r(b)+d}).attr("y",function(a){var b=a[h];if(1==k)if(h==w(0))for(f=1;f<c.length;f++)b+=a[c[f]];else if(h==w(1))for(f=2;f<c.length;f++)b+=a[c[f]];return v+l(b)}).attr("width",function(){return 2==k?r.rangeBand()/c.length:r.rangeBand()}).attr("height",function(a){return m-l(a[h])})}S=!1}function G(a,b){for(var c=0;c<a.length;c++)d3.select(a[c]).style("display",b?"none":"inline-block")}function v(a, b){for(var c=0;c<a.length;c++)d3.select(a[c]).classed("highlight",b)}function T(a){a?(v(["#show_unknown"],!0),d3.select("#show_unknown").text("Hide unknown"),q=!0):(v(["#show_unknown"],!1),d3.select("#show_unknown").text("Show unknown"),q=!1);J(1E3,function(a,b){if(0===a.creator&&0===a.recipient&&0===a.mentioned)return 0;for(var c=0,d=0;c<b;c++)if(0!==e[c].creator||0!==e[c].recipient||0!==e[c].mentioned)d+=1;return 1200/A*(A-d-1)})}function L(a){k=a;v(["#bars_stacked","#bars_split","#bars_seperate"], !1);v(["#bars_"+a],!0);J(1E3,function(a,b){if(0===a.creator&&0===a.recipient&&0===a.mentioned)return 0;for(var c=0,d=0;c<b;c++)if(0!==e[c].creator||0!==e[c].recipient||0!==e[c].mentioned)d+=1;return 1300/A*(A-d-1)})}var g=["creator","recipient","mentioned"],u=["Letters written","Addressee of letters","Mentioned in"],b,B={creator:!1,recipient:!1,mentioned:!1,unknown:!1},D,y;9999===e[e.length-1].year?(B.unknown=!0,y=e,D=e.slice(0,-1)):D=y=e;for(b=0;b<g.length;b++){var f,C=g[b];for(f=0;f<y.length;f++)if(0!= y[f][C]){B[C]=!0;break}}var c=[],x=[];for(b=0;b<g.length;b++)B[g[b]]&&(c.push(g[b]),x.push(u[b]));var q=!0;for(b=0;b<D.length;b++){for(f=0;f<g.length;f++)if(0!=y[b][g[f]]){q=!1;break}if(!q)break}var k=3,g=d3.select("#chart").style("width").replace("px",""),R=100*c.length+25*(c.length-1),z=g-35-15,p=d3.select("#chart").append("svg").attr("class","chart single").attr("width",g).attr("height",R);e=q?y:D;var E=M(e,q),A=e.length,S=!0,K=[];for(b=0;b<c.length;b++){var t=c[b];if(B[t]){var F=125*b+20;p.append("text").classed("chart-title", 1).classed(t,1).attr("x",40).attr("y",F-5).text(x[b]);var l=d3.scale.linear();l.domain([0,E]).rangeRound([60,0]);var g=N(e,q),r=d3.scale.ordinal().domain(g).rangeRoundBands([0,z],.2),g=P(E,k),u=l.ticks(g);p.append("svg:g").classed("guidelines",1).selectAll("line.guideline."+t).data(u,function(a,b){return 0==a?0:b+"-"+t}).enter().append("line").classed("guideline",1).classed(t,1).attr("x1",35).attr("x2",35+z).attr("y1",function(a){return F+l(a)}).attr("y2",function(a){return F+l(a)});u=O(r.domain(), z);u=d3.svg.axis().scale(r).orient("bottom").tickValues(u);C=d3.svg.axis().scale(l).orient("left").tickFormat(d3.format("f")).ticks(g).tickSize(4,2,0);C.tickSubdivide(Q(l.ticks(g),k));K[t]={x:u,y:C};p.append("svg:g").classed("xaxis",1).classed("axis",1).classed("label",1).classed(t,1).attr("transform","translate(35,"+(F+60)+")").call(u);p.append("svg:g").classed("yaxis",1).classed("axis",1).classed("label",1).classed(t,1).attr("transform","translate(35,"+F+")").call(C)}}if(0<c.length){d3.select("#hide_unknown").on("click", function(){T(!1)});d3.select("#show_unknown").on("click",function(){T(!q)});d3.select("#bars_seperate").on("click",function(){L(3)});d3.select("#bars_stacked").on("click",function(){L(1)});d3.select("#bars_split").on("click",function(){L(2)});var H=d3.select(".csstransforms #fullscreen");if(H){G(["#fullscreen"],!1);var I=!1;H.on("click",function(){var a=d3.select("#chart");if(I)a.style("-ms-transform",""),a.style("-webkit-transform",""),a.style("transform",""),H.text("Fullscreen");else{H.text("Close"); var b=window.innerWidth-.04*window.innerWidth,c=window.innerHeight-.04*window.innerHeight,e=a.node().getBoundingClientRect(),d=b/e.width,f=1,f=c/e.height;f*e.width>b&&(f=d);b=(window.innerWidth-e.width)/2;c=(window.innerHeight-e.height)/2;e=""+("scale("+f+")")+(" translate("+(b-e.left)/f+"px,"+(c-e.top)/f+"px)");a.style("-ms-transform",e);a.style("-webkit-transform",e);a.style("transform",e)}I=!I;v(["#fullscreen"],I)})}v(["#show_unknown"],q);G(["#chart .unknown"],!B.unknown);G(["#chart .bars"],1=== c.length);G(["#chart"],!1);J(500,function(a,b){return 0!=a?1200/A*b:0})}})(person_data);